<!DOCTYPE html>  <html> <head>   <title>dice_of_doom.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="dice_of_doom.html">                 dice_of_doom.coffee               </a>                                           <a class="source" href="lazy.html">                 lazy.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               dice_of_doom.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Coffeescript adaptation of the Dice of Doom implementation in <em>Land of Lisp</em>.</p>

<p>mjhoy | michael.john.hoy@gmail.com</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Use underscore.js.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Lazy evaluation functions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span> <span class="nv">lazy: </span><span class="nx">lazy</span><span class="p">,</span> <span class="nv">force: </span><span class="nx">force</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./lazy&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The moves in a tree may be lazily evaluated; force in this case.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">get_moves = </span><span class="nf">(tree) -&gt;</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="nx">force</span> <span class="nx">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="nx">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Game parameter object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DoD = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">DoD</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Define some initial parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DoD.num_players = </span><span class="mi">2</span>
<span class="nv">DoD.max_dice = </span><span class="mi">3</span>
<span class="nv">DoD.board_size = </span><span class="mi">3</span>
<span class="nv">DoD.num_hexes = </span><span class="p">(</span><span class="nx">DoD</span><span class="p">.</span><span class="nx">board_size</span> <span class="o">*</span> <span class="nx">DoD</span><span class="p">.</span><span class="nx">board_size</span><span class="p">)</span>
<span class="nv">DoD.ai_level = </span><span class="mi">4</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>A helper function</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Return a random integer between 0 and n, not inclusive.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randInt = </span><span class="nf">(n) -&gt;</span>
  <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">n</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>Representing the game board</h2>

<p>In LoL, the game board was represented as an array of lists with
a length of two: <code>#((0 3) (0 3) (1 3) (1 1))</code>. Each list represents
a "tile" on the game. The first number is the player number, and
the second is the number of dice.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>In our game we will simply use an array of arrays; e.g.,</p>

<pre><code>[ [ 1, 1 ],
  [ 1, 1 ],
  [ 0, 1 ],
  [ 1, 3 ],
  [ 0, 2 ] ]
</code></pre>

<p>and so on.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Generate a the board data structure.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">gen_board = </span><span class="nf">() -&gt;</span>
  <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">DoD</span><span class="p">.</span><span class="nx">num_hexes</span><span class="p">]</span>
    <span class="nv">player = </span><span class="nx">randInt</span><span class="p">(</span><span class="nx">DoD</span><span class="p">.</span><span class="nx">num_players</span><span class="p">)</span>
    <span class="nv">dice = </span><span class="nx">randInt</span><span class="p">(</span><span class="nx">DoD</span><span class="p">.</span><span class="nx">max_dice</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">[</span><span class="nx">player</span><span class="p">,</span> <span class="nx">dice</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Return the player name for the number (0 -> a, 1 -> b, etc).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">player_letter = </span><span class="nf">(num) -&gt;</span>
  <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">num</span> <span class="o">+</span> <span class="mi">97</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Output an ascii representation of the board.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">draw_ascii_board = </span><span class="nf">(board) -&gt;</span>
  <span class="nv">bs = </span><span class="nx">DoD</span><span class="p">.</span><span class="nx">board_size</span>
  <span class="nv">buf = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">bs</span><span class="p">]</span>
    <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>
    <span class="nx">do</span> <span class="nf">(y) -&gt;</span>
      <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">bs</span> <span class="o">-</span> <span class="nx">y</span><span class="p">)]</span>
        <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">bs</span><span class="p">]</span>
      <span class="nv">hex = </span><span class="nx">board</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">bs</span><span class="p">)]</span>
      <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">player_letter</span><span class="p">(</span><span class="nx">hex</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">hex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
  <span class="nv">buf = </span><span class="nx">buf</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Just use console.log for output now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>Rules</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>The game tree</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>In LoL a game tree is generated recursively with all possible
moves. The "tree" is an array composed of three parts: the
player whose turn it is, the board, and an array of possible
moves, which themselves point to new game trees.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The function to build a tree.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">game_tree = </span><span class="nf">(board, player, spare_dice, first_move) -&gt;</span>
  <span class="p">[</span> 
    <span class="nx">player</span>
    <span class="nx">board</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>The <code>moves</code> array is evaluated lazily.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">lazy</span> <span class="nf">() -&gt;</span> 
      <span class="nx">add_passing_move</span><span class="p">(</span> 
        <span class="nx">board</span> 
        <span class="nx">player</span> 
        <span class="nx">spare_dice</span> 
        <span class="nx">first_move</span> 
        <span class="nx">attacking_moves</span><span class="p">(</span> 
          <span class="nx">board</span> 
          <span class="nx">player</span> 
          <span class="nx">spare_dice</span>
        <span class="p">)</span>
      <span class="p">)</span> 
  <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Add a "pass" move to the tree.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">add_passing_move = </span><span class="nf">(board, player, spare_dice, first_move, moves) -&gt;</span>
  <span class="k">if</span> <span class="nx">first_move</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If this is the first move, a pass isn't a allow. Return the <code>moves</code> list unchanged.
(i.e., a "passing move" is not added to the possible moves list.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">moves</span>

  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Append a passing move to the <code>moves</code> list.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">moves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Create the move. A move is represented by an array. The
first element is a description of the move. In the case of a pass,
it is an empty array.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">[</span> 
        <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>The second element of a move is a game tree representing what happens
after this move.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">game_tree</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Call the <code>add_new_dice</code> function to determine whether any reinforcements
should be given to the player at the end of her turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">add_new_dice</span><span class="p">(</span>
            <span class="nx">board</span>
            <span class="nx">player</span>
            <span class="p">(</span><span class="nx">spare_dice</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Because this is a pass, it's the next player's turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="p">((</span><span class="nx">player</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nx">DoD</span><span class="p">.</span><span class="nx">num_players</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>No spare dice for the new player.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>It is the first turn now.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kc">true</span>
        <span class="p">)</span>
      <span class="p">]</span>
    <span class="p">)</span>

    <span class="nx">moves</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>Attacking</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Return a list of possible attacking moves for the given board, current player, and
also keep track of the spare dice (since spare dice are given for capturing the
opponents' dice.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">attacking_moves = </span><span class="nf">(board, cur_player, spare_dice) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Helper functions to get the player and dice data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">player = </span><span class="nf">(pos) -&gt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">dice   = </span><span class="nf">(pos) -&gt;</span> <span class="nx">board</span><span class="p">[</span><span class="nx">pos</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We will return the <code>moves</code> array at the end, fully populated.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moves = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Loop through each possible <code>src</code> and <code>dst</code> tile: the source must
be owned by <code>cur_player</code>, and the destination must not. The destination
tile must also be neighboring; we ensure this with the <code>neighbors</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">src</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">DoD</span><span class="p">.</span><span class="nx">num_hexes</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">cur_player</span> <span class="o">is</span> <span class="nx">player</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">dst</span> <span class="k">in</span> <span class="nx">neighbors</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur_player</span> <span class="o">isnt</span> <span class="nx">player</span><span class="p">(</span><span class="nx">dst</span><span class="p">))</span> <span class="o">and</span> <span class="p">(</span><span class="nx">dice</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">dice</span><span class="p">(</span><span class="nx">dst</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>This attack is legitimate for the given tile. Create the move.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">move = </span><span class="p">[</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>The description of an attacking move is an array which
contains the source of the attack and the destination
of the attack.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">[</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">dst</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Now construct the new game tree that would result from
the attack.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">game_tree</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Call the <code>board_attack</code> function to change the board
itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">board_attack</span><span class="p">(</span>
                <span class="nx">board</span>
                <span class="nx">cur_player</span>
                <span class="nx">src</span>
                <span class="nx">dst</span>
                <span class="nx">dice</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
              <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Still the current player's move.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">cur_player</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Add the number of dice destroyed to the spare pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="p">(</span><span class="nx">spare_dice</span> <span class="o">+</span> <span class="nx">dice</span><span class="p">(</span><span class="nx">dst</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>It's still the attacker's move, so it can't be the
first move.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="kc">false</span>
            <span class="p">)</span>
          <span class="p">]</span>
          <span class="nx">moves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">move</span><span class="p">)</span>
  <span class="nx">moves</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Return an array of positions that are neighbors (on the hexagonal grid).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">neighbors = </span><span class="nf">(pos) -&gt;</span>
  <span class="nv">bs = </span><span class="nx">DoD</span><span class="p">.</span><span class="nx">board_size</span>
  <span class="nv">up = </span><span class="nx">pos</span> <span class="o">-</span> <span class="nx">bs</span>
  <span class="nv">down = </span><span class="nx">pos</span> <span class="o">+</span> <span class="nx">bs</span>
  <span class="nv">lst = </span><span class="p">[</span>
    <span class="nx">up</span>
    <span class="nx">down</span>
  <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Add nearby hexes, and don't wrap around the board.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">lst</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">up</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">pos</span> <span class="o">%</span> <span class="nx">bs</span>
  <span class="nx">lst</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">down</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nx">bs</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Filter out any hexes that aren't on the board.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">lst</span><span class="p">,</span> <span class="nf">(n) -&gt;</span>
    <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">DoD</span><span class="p">.</span><span class="nx">num_hexes</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Play out an attack move on the board.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">board_attack = </span><span class="nf">(board, player, src, dst, dice) -&gt;</span>
  <span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">hex</span> <span class="k">of</span> <span class="nx">board</span>
    <span class="nv">n = </span><span class="nb">parseInt</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>The source of the attack is left with one die.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">n</span> <span class="o">is</span> <span class="nx">src</span>
      <span class="p">[</span> <span class="nx">player</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>The destination of the attack is left with the
rest of the dice.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">is</span> <span class="nx">dst</span>
      <span class="p">[</span> <span class="nx">player</span><span class="p">,</span> <span class="p">(</span><span class="nx">dice</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Otherwise, the board is unchanged.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nx">hex</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>Reinforcements</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Reinforce the board after play is done. The <code>spare_dice</code> counter is kept
as a turn progresses; it increases as a player captures enemy dice.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">add_new_dice = </span><span class="nf">(board, player, spare_dice) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Keep track of remaining dice as we give them out.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">remaining_dice = </span><span class="nx">spare_dice</span>
  <span class="k">for</span> <span class="nx">hex</span> <span class="k">in</span> <span class="nx">board</span>
    <span class="nv">cur_player = </span><span class="nx">hex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">cur_dice = </span><span class="nx">hex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>If this square can receive dice, give one and continue on.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">remaining_dice</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">cur_player</span> <span class="o">is</span> <span class="nx">player</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">cur_dice</span> <span class="o">&lt;</span> <span class="nx">DoD</span><span class="p">.</span><span class="nx">max_dice</span><span class="p">)</span>
      <span class="nx">remaining_dice</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="p">[</span> <span class="nx">cur_player</span><span class="p">,</span> <span class="nx">cur_dice</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">hex</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h2>Playing against another human</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Text-based; open up stdin.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">stdin = </span><span class="nx">process</span><span class="p">.</span><span class="nx">openStdin</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Begin game.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">startNewGame = </span><span class="nf">() -&gt;</span>
  <span class="nx">play_vs_computer</span> <span class="nx">game_tree</span><span class="p">(</span><span class="nx">gen_board</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Start a play versus a human for game tree <code>tree</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">play_vs_human = </span><span class="nf">(tree) -&gt;</span>
  <span class="nx">print_info</span> <span class="nx">tree</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>The third "slot" in a tree structure is a list of available
moves. If there are none left, someone is a winner.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
    <span class="nx">announce_winner</span><span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hit any key for a new game, or control-d to stop.&quot;</span><span class="p">)</span>
    <span class="nx">stdin</span><span class="p">.</span><span class="nx">once</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span> 
      <span class="nx">startNewGame</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>If not, handle the tree.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">else</span>
    <span class="nx">handle_human</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">play_vs_human</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Calculate the winner[s]. Loop through all the hexes and
tally up the score for each player. Return an array of
winners (more than one in case of a tie.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">winners = </span><span class="nf">(board) -&gt;</span>
  <span class="nv">score = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">hex</span> <span class="k">in</span> <span class="nx">board</span>
    <span class="nv">player = </span><span class="nx">hex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">dice = </span><span class="nx">hex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">score</span><span class="p">[</span><span class="nx">player</span><span class="p">]</span> <span class="o">or=</span> <span class="mi">0</span>
    <span class="nx">score</span><span class="p">[</span><span class="nx">player</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">dice</span>
  <span class="nv">max = </span><span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">score</span><span class="p">)</span>
  <span class="nv">winners = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">select</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">score</span><span class="p">),</span> <span class="nf">(key) -&gt;</span>
      <span class="nx">score</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">is</span> <span class="nx">max</span>
    <span class="nf">(n) -&gt;</span>
      <span class="nb">parseInt</span> <span class="nx">n</span><span class="p">,</span> <span class="mi">10</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Announce the winner.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">announce_winner = </span><span class="nf">(board) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="nv">w = </span><span class="nx">winners</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The game is a tie between&quot;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nf">(n) -&gt;</span> <span class="nx">player_letter</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="p">)</span>
  <span class="k">else</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The winner is&quot;</span><span class="p">,</span> <span class="nx">player_letter</span><span class="p">(</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h2>Text interface</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Print game info.
Remember that the <code>tree</code> data structure is [ player, board, moves ].</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">print_info = </span><span class="nf">(tree) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;current player = &quot;</span><span class="p">,</span> <span class="nx">player_letter</span><span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="nx">draw_ascii_board</span> <span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Handle input from humans. The callback is called after the user
has made a choice.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">handle_human = </span><span class="nf">(tree, callback) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;choose your move:&quot;</span><span class="p">)</span>
  <span class="nv">buf = </span><span class="p">[</span><span class="s2">&quot;\n&quot;</span><span class="p">]</span>
  <span class="nv">moves = </span><span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">move</span> <span class="k">of</span> <span class="nx">moves</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>The first element of a <code>move</code> is a description of the action.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">action = </span><span class="nx">move</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span> <span class="nx">n</span><span class="p">,</span> <span class="s2">&quot;. &quot;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>If the action is an empty list, it's a passing move.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span>
      <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;end turn \n&quot;</span>
    <span class="k">else</span>
      <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span> <span class="nx">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">+</span> <span class="nx">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Handle user input. Node requires here that <code>stdin</code> be non-blocking, so unlike the
implementation in <em>Land of Lisp</em> we generate a callback function to run when the
user makes a choice.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">do</span> <span class="nf">() -&gt;</span>
    <span class="nv">handleChunk = </span><span class="nf">(chunk) -&gt;</span>
      <span class="nv">selection = </span><span class="nb">parseInt</span> <span class="nx">chunk</span><span class="p">,</span> <span class="mi">10</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">moves</span><span class="p">[</span><span class="nx">selection</span><span class="p">])</span>
        <span class="nv">newTree = </span><span class="nx">moves</span><span class="p">[</span><span class="nx">selection</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">newTree</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;unknown command.&quot;</span><span class="p">)</span>
        <span class="nx">stdin</span><span class="p">.</span><span class="nx">once</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">handleChunk</span>

    <span class="nx">stdin</span><span class="p">.</span><span class="nx">once</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">handleChunk</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <h2>Computer AI</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Rate the position for a player and a given tree.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">rate_position = </span><span class="nf">(tree, player) -&gt;</span>
  <span class="nv">moves = </span><span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">moves</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">moves</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Basic minimax algorithm; the position is the
<em>low</em> score if this is the opponent's turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">player</span><span class="p">)</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">max</span> <span class="nx">get_ratings</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">min</span> <span class="nx">get_ratings</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>No moves remain: calculate the winners.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">else</span>
    <span class="nx">score_board</span> <span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">player</span>

<span class="nv">get_ratings = </span><span class="nf">(tree, player) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">),</span> <span class="nf">(move) -&gt;</span>
    <span class="nx">rate_position</span> <span class="nx">move</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">player</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>To handle larger game boards, we need to limit how far ahead the
computer looks. Then the "unseen" nodes will not need to be
evaluated, due to the lazily evaluated game tree.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">limit_tree_depth = </span><span class="nf">(tree, depth) -&gt;</span>
  <span class="p">[</span>
    <span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">do</span> <span class="nf">() -&gt;</span>
      <span class="k">if</span> <span class="nx">depth</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="p">[]</span>
      <span class="k">else</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">),</span> <span class="nf">(move) -&gt;</span>
          <span class="p">[</span>
            <span class="nx">move</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nx">limit_tree_depth</span> <span class="nx">move</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">]</span>
  <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Because we limit the game tree for the computer, the leaf nodes are
not <em>really</em> leaf nodes in the game, so we need a better way of rating
it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">score_board = </span><span class="nf">(board, player) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span> 
    <span class="nx">board</span>
    <span class="nf">(memo, hex, pos) -&gt;</span>
      <span class="nv">v =</span>
        <span class="k">if</span> <span class="nx">hex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="nx">player</span>
          <span class="k">if</span> <span class="nx">threatened</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">board</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Player-owned hex is threatened.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="mi">1</span>
          <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Player-owned hex is unthreatened.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="mi">2</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Opponent-owned hex.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="o">-</span><span class="mi">1</span>
      <span class="nx">memo</span> <span class="o">+</span> <span class="nx">v</span>
    <span class="mi">0</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Is <code>pos</code> a threatened hex?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">threatened = </span><span class="nf">(pos, board) -&gt;</span>
  <span class="nv">hex = </span><span class="nx">board</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span>
  <span class="nv">player = </span><span class="nx">hex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">dice = </span><span class="nx">hex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">any</span> <span class="nx">neighbors</span><span class="p">(</span><span class="nx">pos</span><span class="p">),</span> <span class="nf">(n) -&gt;</span>
    <span class="nv">nhex = </span><span class="nx">board</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
    <span class="nv">nplayer = </span><span class="nx">nhex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">ndice = </span><span class="nx">nhex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">(</span><span class="nx">nplayer</span> <span class="o">isnt</span> <span class="nx">player</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">ndice</span> <span class="o">&gt;</span> <span class="nx">dice</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h3>Handle the computer game loop</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Returns the tree of the move that the computer decides.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">handle_computer = </span><span class="nf">(tree) -&gt;</span>
  <span class="nv">player = </span><span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">ratings = </span><span class="nx">get_ratings</span> <span class="nx">limit_tree_depth</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">DoD</span><span class="p">.</span><span class="nx">ai_level</span><span class="p">),</span> <span class="nx">player</span>
  <span class="nv">move = </span><span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)[</span><span class="nx">ratings</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">max</span> <span class="nx">ratings</span><span class="p">)]</span>
  <span class="nx">move</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nv">play_vs_computer = </span><span class="nf">(tree) -&gt;</span>
  <span class="nx">print_info</span> <span class="nx">tree</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
    <span class="nx">announce_winner</span><span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hit any key for a new game, or control-d to stop.&quot;</span><span class="p">)</span>
    <span class="nx">stdin</span><span class="p">.</span><span class="nx">once</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span> 
      <span class="nx">startNewGame</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>If not, handle the tree.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">else</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nx">handle_human</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">play_vs_computer</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">play_vs_computer</span> <span class="nx">handle_computer</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Begin!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">startNewGame</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 