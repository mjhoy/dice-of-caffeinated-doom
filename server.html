<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="cli.html">                 cli.coffee               </a>                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="dice_of_doom.html">                 dice_of_doom.coffee               </a>                                           <a class="source" href="lazy.html">                 lazy.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">http         = </span><span class="nx">require</span> <span class="s1">&#39;http&#39;</span>
<span class="nv">io           = </span><span class="nx">require</span> <span class="s1">&#39;socket.io&#39;</span>
<span class="nv">fs           = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">coffeescript = </span><span class="nx">require</span> <span class="s1">&#39;coffee-script&#39;</span>
<span class="nv">_            = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span>
<span class="p">{</span>
  <span class="nv">gen_board       : </span><span class="nx">gen_board</span>
  <span class="nv">game_tree       : </span><span class="nx">game_tree</span>
  <span class="nv">get_moves       : </span><span class="nx">get_moves</span>
  <span class="nv">winners         : </span><span class="nx">winners</span>
  <span class="nv">player_letter   : </span><span class="nx">player_letter</span>
  <span class="nv">handle_computer : </span><span class="nx">handle_computer</span>
  <span class="nv">DoD             : </span><span class="nx">DoD</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./dice_of_doom.coffee&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>A really silly server</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">server = </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Compile the client coffeescript.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;/client.js&#39;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">}</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="s1">&#39;./src/client.coffee&#39;</span><span class="p">,</span> <span class="nf">(status, data) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">coffeescript</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="k">else</span> 
    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;/zepto.js&#39;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">}</span>
      <span class="nv">file = </span><span class="s1">&#39;./public/zepto.js&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;/underscore.js&#39;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">}</span>
      <span class="nv">file = </span><span class="s1">&#39;./public/underscore.js&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;/backbone.js&#39;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">}</span>
      <span class="nv">file = </span><span class="s1">&#39;./public/backbone.js&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;/raphael.js&#39;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">}</span>
      <span class="nv">file = </span><span class="s1">&#39;./public/raphael.js&#39;</span>
    <span class="k">else</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/html&#39;</span><span class="p">}</span>
      <span class="nv">file = </span><span class="s1">&#39;./public/index.html&#39;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">(status, data) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">data</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span> <span class="mi">8124</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Server running at 127.0.0.1:8124&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Socket interface</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Socket for handling game client connections.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">socket = </span><span class="nx">io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>

<span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="nf">(client) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Client connected. Start a new game!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tree = </span><span class="nx">game_tree</span><span class="p">(</span><span class="nx">gen_board</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Send the client game constants.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nv">DoD: </span><span class="nx">DoD</span><span class="p">})</span>

  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Handle client actions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
  <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Start the game.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">play_vs_computer</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">client</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Game server logic</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Simplify an array of moves into just an array of action descriptions 
(i.e., don't include the game trees).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">client_moves = </span><span class="nf">(moves) -&gt;</span>
  <span class="k">for</span> <span class="nx">move</span> <span class="k">in</span> <span class="nx">moves</span>
    <span class="nx">move</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Send game information to the client.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">print_info = </span><span class="nf">(tree, client) -&gt;</span>
  <span class="nv">board = </span><span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nv">player = </span><span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="p">{</span>
    <span class="nv">board: </span> <span class="nx">board</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Can't send a 0, make a string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">player: </span><span class="nx">player</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Run a turn.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">play_vs_computer = </span><span class="nf">(tree, client) -&gt;</span>
  <span class="nx">print_info</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">client</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
    <span class="nx">announce_winner</span><span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">client</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nx">handle_web_human</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">client</span>
    <span class="k">else</span>
      <span class="nx">handle_web_computer</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">client</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Handle the web computer's turn. Set a second timeout for the move to get played,
so the user can see what's going on.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">handle_web_computer = </span><span class="nf">(tree, client) -&gt;</span>
  <span class="nx">setTimeout</span><span class="p">(</span>
    <span class="nf">() -&gt;</span>
      <span class="nx">play_vs_computer</span> <span class="nx">handle_computer</span><span class="p">(</span><span class="nx">tree</span><span class="p">),</span> <span class="nx">client</span>
    <span class="mi">1000</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Handle the human web client. Send a list of
possible moves.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">handle_web_human = </span><span class="nf">(tree, client) -&gt;</span>
  <span class="nv">moves = </span><span class="nx">get_moves</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="p">{</span>
    <span class="nv">moves: </span><span class="nx">client_moves</span><span class="p">(</span><span class="nx">moves</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">removeAllListeners</span> <span class="s1">&#39;message&#39;</span>
  <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
    <span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">move</span>
      <span class="nv">newTree = </span><span class="nx">moves</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">move</span><span class="p">,</span><span class="mi">10</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
      <span class="nx">play_vs_computer</span> <span class="nx">newTree</span><span class="p">,</span> <span class="nx">client</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Announce winner. Some of this should go in client.coffee.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">announce_winner = </span><span class="nf">(board, client) -&gt;</span>
  <span class="nv">w = </span><span class="nx">winners</span><span class="p">(</span><span class="nx">board</span><span class="p">)</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="p">{</span>
    <span class="nv">winners: </span><span class="nx">w</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 